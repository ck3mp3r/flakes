name: check-flakes
on:
  push:
    branches-ignore:
      - main

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2 # Need to fetch at least 2 commits to compare

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup CI Tools
        uses: ck3mp3r/actions/ci-tools@main

      - name: Check changed flakes
        shell: nu {0}
        run: |
          use ci *

          # Get changed directories from last commit
          let paths_to_check = (git diff --name-only HEAD~1 HEAD | lines | each {|f| $f | path expand | path dirname})

          # Get actual flakes from changed paths
          let changed_flakes = ($paths_to_check | ci nix flakes)

          if ($changed_flakes | is-empty) {
            "No flakes changed, skipping checks" | ci log info
          } else {
            $"Found ($changed_flakes | length) changed flake\(s\):" | ci log info
            $changed_flakes | each {|f| $"  - ($f)" | ci log info}

            # Run nix flake check on changed flakes
            let check_results = ($changed_flakes | ci nix check --args "--show-trace")

            # Check if any failed
            let failures = ($check_results | where status == "failed")

            if not ($failures | is-empty) {
              "Some flake checks failed:" | ci log error
              $failures | each {|f| $"  âœ— ($f.flake): ($f.error)" | ci log error}
              exit 1
            }

            "All checks passed!" | ci log info
          }
