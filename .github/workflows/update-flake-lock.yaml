name: update-flake-lock
on:
  workflow_dispatch: # allows manual triggering
  schedule:
    - cron: "0 0 * * 0" # runs weekly on Sunday at 00:00

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  # Stage 1: Update base-nixpkgs first (single source of truth)
  update-base-nixpkgs:
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'pull_request' && github.ref == 'refs/heads/main' }}
    outputs:
      pull-request-number: ${{ steps.create-pr.outputs.pr-number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup CI Tools
        uses: ck3mp3r/actions/ci-tools@main

      - name: Update base-nixpkgs flake.lock
        shell: nu {0}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          use ci *

          "github-actions[bot]@users.noreply.github.com" | ci scm config

          # Create and switch to update branch (also pulls latest)
          let branch_desc = $"update-base-nixpkgs-(date now | format date '%Y%m%d-%H%M%S')"
          let branch_result = ($branch_desc | ci scm branch --chore)
          let branch_name = $branch_result.branch

          # Update flake.lock
          "base-nixpkgs" | ci nix update

          # Check if there are changes
          let changed_files = (ci scm changes | where {|it| $it =~ "flake.lock"})

          if not ($changed_files | is-empty) {
            # Stage, commit, and push
            ["base-nixpkgs/flake.lock"] | ci scm commit --message "chore: update base-nixpkgs flake.lock" --push

            # Create PR
            ci github pr create "chore: update base-nixpkgs flake.lock" "Automated update of base-nixpkgs flake.lock (single source of truth for nixpkgs versions)."

            # Get PR info for current branch
            let pr_info = (ci github pr info $branch_name)
            let pr_number = $pr_info.number

            # Merge PR immediately
            ci github pr merge $pr_number --method squash --delete-branch

            $"pr-number=($pr_number)" | save --append $env.GITHUB_OUTPUT
          } else {
            "No changes to base-nixpkgs flake.lock" | ci log info
          }

  # Stage 2: Update all other flakes after base-nixpkgs is merged
  update-other-flakes:
    runs-on: ubuntu-latest
    needs: update-base-nixpkgs
    if: ${{ needs.update-base-nixpkgs.outputs.pull-request-number != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup CI Tools
        uses: ck3mp3r/actions/ci-tools@main

      - name: Update all flakes after base-nixpkgs merge
        shell: nu {0}
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ needs.update-base-nixpkgs.outputs.pull-request-number }}
        run: |
          use ci *

          "github-actions[bot]@users.noreply.github.com" | ci scm config

          # Wait for base-nixpkgs PR to be merged
          $"Waiting for base-nixpkgs PR #($env.PR_NUMBER) to be merged..." | ci log info

          mut timeout = 300
          mut merged = false

          while $timeout > 0 {
            let pr_info = (ci github pr info $env.PR_NUMBER)
            if $pr_info.merged {
              $merged = true
              break
            }
            "Waiting..." | ci log info
            sleep 10sec
            $timeout = $timeout - 10
          }

          if not $merged {
            "Timeout waiting for merge, continuing anyway..." | ci log warning
          }

          # Create and switch to update branch (also pulls latest)
          let branch_desc = $"update-all-flakes-(date now | format date '%Y%m%d-%H%M%S')"
          let branch_result = ($branch_desc | ci scm branch --chore)
          let branch_name = $branch_result.branch

          # Update all flakes
          let flakes = [k8s-utils opencode rustnix slidev topiary-nu]

          $flakes | ci nix update

          # Check if there are changes
          let changed_files = (ci scm changes | where {|it| $it =~ "flake.lock"})

          if not ($changed_files | is-empty) {
            # Build commit message
            let files = ($flakes | each {|f| $"- ($f)"})
            let body = (["Updated after base-nixpkgs merge:"] | append $files | str join "\n")
            let full_message = $"chore: update all flake locks\n\n($body)"

            # Stage, commit, and push all changes
            ci scm commit --message $full_message --push

            # Create PR
            let pr_body = $"Automated update of all flake locks after base-nixpkgs was updated and merged. Updated: ($flakes | str join ', ')"
            ci github pr create "chore: update all flake locks" $pr_body

            # Get PR info for current branch
            let pr_info = (ci github pr info $branch_name)
            let pr_number = $pr_info.number

            # Merge PR immediately
            ci github pr merge $pr_number --method squash --delete-branch
          } else {
            "No changes to flake locks" | ci log info
          }
