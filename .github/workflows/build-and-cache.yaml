name: build-and-cache
on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-and-cache:
    runs-on: macos-latest
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2 # Need to fetch at least 2 commits to compare

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nu Tools
        uses: ck3mp3r/actions/nu-tools@main

      - name: Install Cachix
        run: nix profile install nixpkgs#cachix

      - name: Detect changed flakes and build to cache
        shell: nu {0}
        env:
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
        run: |
          use nu-tools *

          print $"(ansi cyan_bold)ğŸ” Detecting changed flakes...(ansi reset)\n"

          # Get list of changed files in the last commit
          let changed_files = (git diff --name-only HEAD~1 HEAD | lines)

          print $"Changed files:"
          $changed_files | each {|f| print $"  â€¢ ($f)"}
          print ""

          # Extract flake directories (top-level directories with flake.nix)
          let flake_dirs = [base-nixpkgs k8s-utils mods opencode rustnix slidev topiary-nu]

          let changed_flakes = ($changed_files
            | each {|file|
                let parts = ($file | split row '/')
                if ($parts | length) > 0 {
                  $parts.0
                } else {
                  null
                }
              }
            | uniq
            | where {|dir| $dir in $flake_dirs}
            | uniq
          )

          if ($changed_flakes | is-empty) {
            print $"(ansi yellow)âš  No flake changes detected, skipping build(ansi reset)"
            exit 0
          }

          print $"(ansi green)âœ“ Detected changed flakes:(ansi reset)"
          $changed_flakes | each {|f| print $"  â€¢ ($f)"}
          print ""

          # Build and cache each changed flake
          for flake in $changed_flakes {
            print $"(ansi cyan_bold)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”(ansi reset)"
            print $"(ansi cyan_bold)ğŸ“¦ Processing flake: ($flake)(ansi reset)"
            print $"(ansi cyan_bold)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”(ansi reset)\n"

            try {
              # Build flake from the flake directory
              cd $flake
              publish-to-cachix ck3mp3r --flake ".#"
              cd ..
            } catch {|err|
              print $"(ansi red_bold)âŒ Failed to build/cache ($flake):(ansi reset)"
              print $err
              print $"(ansi yellow)âš  Continuing with next flake...(ansi reset)\n"
              cd ..
            }

            print ""
          }

          print $"(ansi green_bold)âœ… Build and cache workflow completed!(ansi reset)"
