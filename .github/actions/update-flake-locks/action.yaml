name: Update Flake Locks
description: Update flake locks and create/merge PR

inputs:
  github-token:
    description: 'GitHub token for authentication'
    required: true
  name:
    description: 'Short name for branch/PR (e.g., base-nixpkgs, flakes)'
    required: true
  flakes:
    description: 'Space-separated list of flakes to update'
    required: true
  pr-body:
    description: 'Pull request body (optional, will be auto-generated if not provided)'
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Setup CI Tools
      uses: ck3mp3r/actions/ci-tools@main

    - name: Update or merge flakes
      shell: nu {0}
      env:
        GH_TOKEN: ${{ inputs.github-token }}
      run: |
        use ci *

        "ck3mp3r-bot[bot]@users.noreply.github.com" | ci scm config

        # Derived values
        let name = "${{ inputs.name }}"

        # Parse flakes input (space-separated)
        let flakes = "${{ inputs.flakes }}" | split row " "
        let flakes_count = ($flakes | length)

        # Determine if singular or plural
        let lock_suffix = if $flakes_count > 1 { "locks" } else { "lock" }
        let pr_title = $"chore: update ($name) flake ($lock_suffix)"

        # Use provided pr-body or generate default
        let pr_body = if "${{ inputs.pr-body }}" != "" {
          "${{ inputs.pr-body }}"
        } else {
          $"Automated update of ($name) flake ($lock_suffix)."
        }

        # Create or checkout branch (handles both new and existing branches)
        let branch_result = ($"update-($name)" | ci scm branch --chore --reuse)

        if $branch_result.status != "success" {
          $"Failed to create/checkout branch: ($branch_result.error)" | ci log error
          exit 1
        }

        let branch_name = $branch_result.branch

        # Check if PR already exists for this branch
        let existing_prs = (ci github pr check --target main)

        if ($existing_prs | is-not-empty) {
          # PR exists - this is the second run, check if we should merge
          let pr = $existing_prs | first
          let pr_number = $pr.number

          $"PR #($pr_number) exists for branch ($branch_name)" | ci log info

          # Get detailed PR info
          let pr_info = (ci github pr info $pr_number)

          if $pr_info.mergeable == "MERGEABLE" {
            $"All checks passed, merging PR #($pr_number)" | ci log info
            ci github pr merge $pr_number --method squash
            $"PR merged successfully!" | ci log info
          } else {
            $"PR #($pr_number) is not mergeable yet (status: ($pr_info.mergeable))" | ci log warning
          }
        } else {
          # No PR exists - this is the first run, update and create PR
          $"No existing PR for branch ($branch_name), updating flakes..." | ci log info

          # Update flakes
          let flakes_expanded = ($flakes | path expand)
          $flakes_expanded | ci nix update

          # Check if there are changes
          let changed_files = (ci scm changes | where {|it| $it =~ "flake.lock"})

          if not ($changed_files | is-empty) {
            # Stage, commit, and push
            ci scm commit --message $pr_title --push

            # Create PR
            let pr_info = (ci github pr create $pr_title $pr_body)
            $"Created PR #($pr_info.number): ($pr_info.url)" | ci log info
          } else {
            $"No changes to ($name) flake ($lock_suffix)" | ci log info
          }
        }
